# เซิร์ฟเวอร์ซิงค์ที่โฮสต์เอง

ผู้ใช้ขั้นสูงที่ไม่สามารถหรือไม่ต้องการใช้ AnkiWeb สามารถใช้เซิร์ฟเวอร์ซิงค์ที่โฮสต์เองแทนได้

ข้อควรระวัง:

- นี่คือฟีเจอร์ขั้นสูง สำหรับผู้ใช้ที่คุ้นเคยกับระบบเครือข่ายและคอมมานด์ไลน์ หากคุณใช้ฟีเจอร์นี้ เราคาดหวังว่าคุณจะสามารถแก้ไขปัญหาการตั้งค่า/เครือข่าย/ไฟร์วอลล์ที่พบเจอได้ด้วยตนเอง และการใช้งานนี้ถือเป็นความเสี่ยงของคุณเองทั้งหมด
- ไคลเอนต์เวอร์ชันใหม่อาจต้องใช้โปรโตคอลการซิงค์ที่มีการเปลี่ยนแปลง ดังนั้นการซิงค์อาจหยุดทำงานหากคุณอัปเดตไคลเอนต์ Anki ของคุณโดยไม่ได้อัปเดตเซิร์ฟเวอร์ด้วย
- มีเซิร์ฟเวอร์ซิงค์ของบุคคลที่สามอยู่เช่นกัน แต่ไม่มีการทดสอบกับเซิร์ฟเวอร์เหล่านั้น และมักจะใช้เวลาในการอัปเดตตามเมื่อโปรโตคอลการซิงค์เปลี่ยนแปลง ดังนั้นจึงไม่แนะนำให้ใช้
- ข้อความภายใน Anki จะใช้คำว่า "AnkiWeb" แม้ว่าจะมีการกำหนดค่าเซิร์ฟเวอร์เองก็ตาม (เช่น "ไม่สามารถเชื่อมต่อกับ AnkiWeb" เมื่อเซิร์ฟเวอร์ของคุณล่ม)

## การติดตั้ง/การรัน

มีหลายวิธีที่คุณสามารถติดตั้งและรันเซิร์ฟเวอร์ได้ คุณสามารถใช้:

- เซิร์ฟเวอร์ซิงค์ที่มาพร้อมกับ Anki เวอร์ชันเดสก์ท็อป
- เซิร์ฟเวอร์ซิงค์ขนาดเล็กแยกต่างหากที่ไม่รวมส่วนประกอบ GUI ของ Anki มีให้ใช้งานทั้งแบบ Python และ Rust

### จากเวอร์ชันที่แพ็กเกจแล้ว

วิธีนี้ใช้เซิร์ฟเวอร์ซิงค์ที่ติดตั้งมาพร้อมกับ Anki เวอร์ชันเดสก์ท็อปตั้งแต่เวอร์ชัน 2.1.57 ขึ้นไป

บน Windows ใน cmd.exe:

```
set SYNC_USER1=user:pass
"\Program Files\anki\anki.exe" --syncserver
```

หรือบน MacOS ใน Terminal.app:

```
SYNC_USER1=user:pass /Applications/Anki.app/Contents/MacOS/anki --syncserver
```

หรือบน Linux:

```
SYNC_USER1=user:pass anki --syncserver
```

### ด้วย Pip

เพื่อหลีกเลี่ยงการดาวน์โหลดส่วนประกอบ GUI ของ Anki สำหรับเดสก์ท็อป คุณสามารถรันเซิร์ฟเวอร์ซิงค์ Anki แบบสแตนด์อโลนโดยใช้แพ็กเกจ Python ที่ดาวน์โหลดจาก PyPI แทน
ตรวจสอบให้แน่ใจว่าคุณได้ติดตั้ง Python 3.9+ แล้ว

```
python3 -m venv ~/syncserver
~/syncserver/bin/pip install anki
SYNC_USER1=user:pass ~/syncserver/bin/python -m anki.syncserver
```

### ด้วย Cargo

ตั้งแต่ Anki 2.1.66+ เป็นต้นไป คุณสามารถสร้างเซิร์ฟเวอร์ซิงค์แบบสแตนด์อโลนที่เขียนด้วย Rust โดยใช้คำสั่งด้านล่าง
ตรวจสอบให้แน่ใจว่าคุณได้ติดตั้ง Rustup แล้ว

```
cargo install --locked --git https://github.com/ankitects/anki.git --tag 25.02.5 anki-sync-server
```

แทนที่ 25.02.5 ด้วยเวอร์ชันล่าสุดของ Anki

จำเป็นต้องติดตั้ง Protobuf (protoc)

หลังจากสร้างเสร็จแล้ว คุณสามารถรันด้วยคำสั่ง:

```
SYNC_USER1=user:pass anki-sync-server
```

### จากซอร์สโค้ดที่โคลนมา

หากคุณได้โคลน repository ของ Anki จาก GitHub คุณสามารถติดตั้งจากที่นั่นได้:

```
./ninja extract:protoc ftl_repo
cargo install --path rslib/sync
```

### ด้วย Docker

คุณสามารถหา Dockerfile ที่ผู้ใช้สร้างขึ้นและคำแนะนำบางส่วนได้
[ที่นี่](https://github.com/ankitects/anki/tree/main/docs/syncserver)

## ผู้ใช้หลายคน

`SYNC_USER1` ใช้สำหรับประกาศผู้ใช้และรหัสผ่านคนแรก และต้องตั้งค่านี้
คุณสามารถประกาศ `SYNC_USER2`, `SYNC_USER3` และอื่นๆ เพิ่มเติมได้ หากคุณ
ต้องการตั้งค่าหลายบัญชี

## รหัสผ่านที่แฮชแล้ว

ผู้ใช้ขั้นสูงอาจต้องการใช้รหัสผ่านที่แฮชแล้วแทนรหัสผ่านแบบข้อความธรรมดา
หากคุณต้องการทำเช่นนี้ คุณจะต้องใช้เครื่องมือแยกต่างหาก (เช่น
[อันนี้](https://git.sr.ht/~laalsaas/pbkdf2-password-hash)) เพื่อสร้างแฮชของรหัสผ่าน จากนั้นคุณสามารถบอกเซิร์ฟเวอร์ให้คาดหวังรหัสผ่านที่แฮชแล้วโดยการตั้งค่าตัวแปรสภาพแวดล้อม PASSWORDS_HASHED เป็น 1 (หรือค่าอื่นใดก็ได้)

เมื่อใช้รหัสผ่านที่แฮชแล้ว ตัวแปร SYNC_USER จะต้องอยู่ในรูปแบบ
username:password_hash โดยที่ password_hash คือแฮชของรหัสผ่านใน
รูปแบบ PHC

## ตำแหน่งที่จัดเก็บ

เซิร์ฟเวอร์จำเป็นต้องเก็บสำเนาของชุดการ์ดและสื่อของคุณไว้ในโฟลเดอร์
โดยค่าเริ่มต้นจะอยู่ที่ ~/.syncserver; คุณสามารถเปลี่ยนได้โดยการกำหนด
ตัวแปรสภาพแวดล้อม `SYNC_BASE`

- ตำแหน่งนี้ต้องไม่ซ้ำกับโฟลเดอร์ข้อมูล Anki ปกติของคุณ เนื่องจาก
  เซิร์ฟเวอร์และไคลเอนต์ต้องเก็บสำเนาแยกกัน
- คุณต้องซิงค์ข้อมูลของคุณไปยังเซิร์ฟเวอร์ ไม่ใช่คัดลอกไฟล์เข้าไปใน
  โฟลเดอร์ของเซิร์ฟเวอร์ด้วยตนเอง

## การเข้าถึงแบบสาธารณะ

เซิร์ฟเวอร์จะรอรับการเชื่อมต่อผ่าน HTTP ที่ไม่ได้เข้ารหัส ดังนั้นจึงไม่ควร
เปิดให้เข้าถึงได้โดยตรงจากอินเทอร์เน็ต คุณควรจำกัดการใช้งาน
ให้อยู่ในเครือข่ายท้องถิ่นของคุณ หรือวางรูปแบบการเข้ารหัสบางอย่างไว้หน้า
เซิร์ฟเวอร์ เช่น VPN (Tailscale ดูเหมือนจะง่าย) หรือ HTTPS
reverse proxy

คุณสามารถกำหนด `SYNC_HOST` และ `SYNC_PORT` เพื่อเปลี่ยนโฮสต์และพอร์ต
ที่เซิร์ฟเวอร์จะผูกไว้

## การตั้งค่าไคลเอนต์

คุณจะต้องหาที่อยู่ IP ของเครือข่ายคอมพิวเตอร์ของคุณ จากนั้น
ชี้ไคลเอนต์ Anki แต่ละตัวของคุณไปยังที่อยู่นั้น เช่น `http://192.168.1.200:8080/` URL นี้สามารถกำหนดค่าได้ในการตั้งค่า

หากคุณใช้ AnkiMobile และไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ในเครือข่ายท้องถิ่นของคุณได้
โปรดไปที่การตั้งค่าของ iOS ค้นหา Anki ที่ด้านล่าง และ
สลับ "Allow Anki to access local network" (อนุญาตให้ Anki เข้าถึงเครือข่ายท้องถิ่น) ปิดแล้วเปิดใหม่อีกครั้ง

ไคลเอนต์เดสก์ท็อปเวอร์ชันเก่าต้องการให้คุณกำหนด `SYNC_ENDPOINT` และ
`SYNC_ENDPOINT_MEDIA` หากใช้ไคลเอนต์เวอร์ชันเก่า คุณจะต้องใส่เป็นเช่น
`http://192.168.1.200:8080/sync/` และ `http://192.168.1.200:8080/msync/`
ตามลำดับ ไคลเอนต์ AnkiDroid ก่อนเวอร์ชัน 2.16 ต้องการการกำหนดค่าแยกกันสำหรับ
endpoint ทั้งสอง

## Reverse Proxies

หากใช้ reverse proxy เพื่อให้สามารถเข้าถึงผ่าน HTTPS (เช่น nginx) และผูกกับ subpath
(เช่น `http://example.com/custom/` -> `http://localhost:8080/`) คุณต้องแน่ใจว่า
ได้ใส่เครื่องหมายทับต่อท้าย (trailing slash) เมื่อกำหนดค่า Anki หากคุณใส่เป็น `http://example.com/custom`
แทน มันจะไม่ทำงาน

บน iOS ไม่รองรับ TLS 1.3 ดังนั้น reverse proxy ของคุณจะต้องเปิดใช้งาน TLS 1.2
มิฉะนั้นคุณจะได้รับข้อความ "error code -9836"

## คำขอขนาดใหญ่

ขีดจำกัดการอัปโหลดมาตรฐานของ AnkiWeb จะถูกนำมาใช้เป็นค่าเริ่มต้น คุณสามารถ
ตั้งค่า `MAX_SYNC_PAYLOAD_MEGS` ให้มากกว่า 100 ได้หากต้องการ
เพิ่มขีดจำกัด โปรดทราบว่าหากคุณใช้ reverse proxy คุณอาจ
ต้องปรับขีดจำกัดที่นั่นด้วย

## การมีส่วนร่วมในการเปลี่ยนแปลง

เนื่องจากเซิร์ฟเวอร์นี้มาพร้อมกับ Anki ความเรียบง่ายจึงเป็นเป้าหมายในการออกแบบ - มัน
มีเป้าหมายเพื่อการใช้งานส่วนบุคคล/ครอบครัว และ PR ที่เพิ่มสิ่งต่างๆ เช่น REST API หรือ
ฐานข้อมูลภายนอก ไม่น่าจะได้รับการยอมรับในขณะนี้ หากไม่แน่ใจ โปรด
ติดต่อสอบถามก่อนเริ่มทำงานกับ PR

หากคุณกำลังมองหาโซลูชัน API ที่มีอยู่แล้ว ส่วนเสริม AnkiConnect อาจ
ตอบสนองความต้องการของคุณได้